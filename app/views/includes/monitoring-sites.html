<h2 class="govuk-heading-m">Air pollutants monitored near by</h2>
{% set tabItems = [] %} {# Initialize an empty array to hold tab items #}

{% for site in monitoringSites %}
  {% set measurementToggletip %}
    {{ toggletip(
      '',
      'More information about measurement',
      'Readings are measured every hour. The unit µg/&#13221; stands for micrograms (one millionth of a gram) per cubic metre of air.',
      'Latest'
    )}}
  {% endset %}

  {% set trendToggletip %}
    {{ toggletip(
      '',
      'More information about the trend',
      'The trend is taken from the last 3 readings which are updated hourly',
      'Trend'
    )}}
  {% endset %}

  {% set levelToggletip %}
    {{ toggletip(
      '',
      'More information about the level',
      'There are 4 levels: low, moderate, high and very high.',
      'Level'
    )}}
  {% endset %}
  {% set siteNameToggletip %}
  {{ toggletip(
    '',
    'More information about ' + site.site_name,
    siteTypeDescriptions[site.site_type],
    site.site_name
  )}}
{% endset %}

  {% set rows = [] %}
  {% for pollutant in site.pollutants %}
    {% set pollutantDetail = pollutantTypes[pollutant.type] %}
    {% set row = [
        { 
            html: "<a class='govuk-!-margin-bottom-1' href='" ~ pollutantDetail.href ~ "'>" ~ pollutantDetail.title ~ "</a><span class='govuk-caption-s govuk-!-margin-bottom-1'>Low range " ~ pollutantDetail.low_range ~ "</span>",
            classes: "defra-aq-levels-table__cell--pollutant" 
        },
        { 
            html: (pollutant.measurement | int) ~ " <span class='govuk-!-font-size-16 govuk-!-font-weight-regular'>μg/&#13221;</span>",
            classes: "defra-aq-levels-table__cell--reading" 
        },
        { 
            html: pollutant.trend, 
            classes: "defra-aq-levels-table__cell--trend" 
        },
        { 
            html: "<strong class='daqi-tag daqi-tag--" ~ (pollutant.aqi if pollutant.aqi else "default-aqi-value") ~ "'>" ~ pollutant.band ~ "</strong>",
            classes: "defra-aq-levels-table__cell--level" 
        }
    ] %}
    {% set _ = rows.push(row) %}
  {% endfor %}

  {% set panelHtml %}
    <h3 class="govuk-heading-s govuk-!-margin-bottom-4">{{ siteNameToggletip | safe }}</h3>
    {{ aqLevelsTable({
        classes: "govuk-!-margin-bottom-2",
        firstCellIsHeader: false,
        head: [
          { text: "Pollutant", classes: "defra-aq-levels-table__cell--pollutant"},
          { html: measurementToggletip, classes: "defra-aq-levels-table__cell--reading" },
          { html: trendToggletip, classes: "defra-aq-levels-table__cell--trend" },
          { html: levelToggletip, classes: "defra-aq-levels-table__cell--level" }
        ],
        rows: rows
    }) }}
    <p class='govuk-caption-s govuk-!-margin-bottom-8'>Latest {{ "now" | date | minusOneHour | lower }}</p>
  {% endset %}

  {% set tabItem = {
    classes: "govuk-tabs__list-item--sites",
    label: site.site_name | truncate(15),
    status: "<span class='defra-aq-tabs__label-distance'>" ~ site.distance ~ " miles away</span>",
    id: site.site_id,
    panel: {
      html: panelHtml
    }
  } %}

  {% set _ = tabItems.push(tabItem) %}
{% endfor %}

{{ aqTabs({
  classes: "defra-aq-tabs",
  items: tabItems
}) }}
